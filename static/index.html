<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV - Modern Parser</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.5);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            /* Modern Mesh Gradient Background */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* --- Layout Architecture --- */
        .app-wrapper {
            display: flex;
            width: 95vw;
            height: 90vh;
            max-width: 1400px;
            gap: 20px;
        }

        /* Sidebar (Navigation) */
        .sidebar {
            width: 260px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            border-radius: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .logo-area h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .logo-area p { font-size: 0.8rem; color: var(--text-muted); }

        /* Navigation Tabs */
        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 40px;
        }

        .tab {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab svg { width: 20px; height: 20px; fill: currentColor; opacity: 0.7; }

        .tab:hover {
            background: var(--glass-highlight);
            color: #fff;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 20px var(--accent-glow);
        }
        
        .tab.hidden { display: none; }

        /* Main Content Area */
        .main-content {
            flex: 1;
            position: relative;
            border-radius: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            overflow: hidden; /* For scroll handling */
            display: flex;
            flex-direction: column;
        }

        .content-scroll-area {
            padding: 30px;
            overflow-y: auto;
            height: 100%;
        }

        /* --- Auth & User Profile --- */
        .user-profile {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 12px;
            background: rgba(0,0,0,0.2);
        }

        .avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #db2777);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .user-info-text {
            flex: 1;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-info-text span { display: block; color: #fff; font-weight: 600;}
        .user-info-text small { color: var(--text-muted); font-size: 0.7rem; }

        /* Modern Logout Button */
        .logout-btn {
            background: transparent;
            border: none;
            color: var(--error);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: translateX(2px);
        }

        /* --- Sections & Forms --- */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 { margin-bottom: 20px; font-weight: 600; letter-spacing: -0.5px; }

        /* Bento Grid for Auth */
        .auth-container {
            display: grid;
            place-items: center;
            height: 100%;
        }

        .auth-box {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background: rgba(0,0,0,0.2);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
        }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--glass-border);
            box-shadow: none;
        }

        .btn-secondary:hover { background: var(--glass-highlight); }

        /* Upload Area (Bento Tile) */
        .upload-bento {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .file-drop-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.01);
            transition: 0.3s;
            position: relative;
        }

        .file-drop-zone:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-input-wrapper input[type=file] {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;
        }

        .upload-icon { font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5; }

        /* Data Tables (Glass Table) */
        .table-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            margin-top: 20px;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
        }

        .task-table th {
            text-align: left;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .task-table td {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
        }

        .task-table tr:last-child td { border-bottom: none; }
        .task-table tr:hover td { background: rgba(255, 255, 255, 0.03); }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-badge.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        .status-badge.processing { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-badge.completed, .status-badge.done { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status-badge.failed { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }

        /* Filters Bar (Bento Strip) */
        .filters-bar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            display: none;
        }
        .message.success { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #a7f3d0; }
        .message.error { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #fecaca; }
        .message.info { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #bfdbfe; }

        /* Utilities */
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 60px; color: var(--text-muted); }
        .spinner {
            width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff; border-radius: 50%;
            animation: spin 1s linear infinite; display: inline-block; margin-left: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Movie Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            flex: 1;
            line-height: 1.3;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-main);
            transition: all 0.2s;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.05);
        }

        .modal-body {
            display: grid;
            gap: 20px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 0.95rem;
            color: var(--text-main);
            word-break: break-word;
        }

        .detail-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .movie-overview {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            line-height: 1.6;
        }

        .movie-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .movie-row-clickable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .movie-row-clickable:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-wrapper { flex-direction: column; height: 100vh; width: 100vw; border-radius: 0; }
            .sidebar { width: 100%; flex-direction: row; height: 70px; padding: 10px 20px; border-radius: 0; align-items: center; }
            .nav-links { flex-direction: row; margin-top: 0; }
            .tab span { display: none; } /* Hide text on mobile tabs */
            .tab { padding: 10px; }
            .user-profile { display: none; } /* Hide user profile on nav bar for mobile, maybe add to top */
            .main-content { border-radius: 0; border: none; }
            
            .modal-content {
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }
            
            .modal-title {
                font-size: 1.4rem;
            }
            
            .detail-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .movie-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <nav class="sidebar">
            <div class="logo-area">
                <h1>CSV</h1>
                <p>CSV Parser & Analytics</p>
            </div>

            <div class="nav-links">
                <button class="tab active" id="auth-tab" onclick="switchTab('auth')">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span>Login</span>
                </button>
                <button class="tab hidden" id="upload-tab" onclick="switchTab('upload')">
                    <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                    <span>Upload</span>
                </button>
                <button class="tab hidden" id="tasks-tab" onclick="switchTab('tasks')">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    <span>Tasks</span>
                </button>
                <button class="tab hidden" id="movies-tab" onclick="switchTab('movies')">
                    <svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                    <span>Database</span>
                </button>
            </div>

            <div id="logged-in-view" class="user-profile hidden">
                <div class="user-card">
                    <div class="avatar">U</div>
                    <div class="user-info-text">
                        <span id="current-user">User</span>
                        <small>Online</small>
                    </div>
                    <button class="logout-btn" onclick="logout()" title="Logout">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </button>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-scroll-area">
                
                <div id="auth-section" class="section active">
                    <div id="auth-message" class="message"></div>
                    
                    <div class="auth-container">
                        <div class="auth-box">
                            <div id="login-form">
                                <h2>Welcome Back</h2>
                                <p style="margin-bottom: 20px; color: var(--text-muted);">Enter your credentials to access the database.</p>
                                <form onsubmit="login(event)">
                                    <div class="form-group">
                                        <label>Username</label>
                                        <input type="text" id="login-username" required placeholder="e.g. admin">
                                    </div>
                                    <div class="form-group">
                                        <label>Password</label>
                                        <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button type="submit" class="btn" style="flex: 1;">Login</button>
                                        <button type="button" class="btn btn-secondary" onclick="toggleAuthForm()">Register</button>
                                    </div>
                                </form>
                            </div>

                            <div id="register-form" class="hidden">
                                <h2>Create Account</h2>
                                <form onsubmit="register(event)">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input type="text" id="register-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="register-email" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Username</label>
                                        <input type="text" id="register-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Password</label>
                                        <input type="password" id="register-password" required minlength="6">
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button type="submit" class="btn" style="flex: 1;">Register</button>
                                        <button type="button" class="btn btn-secondary" onclick="toggleAuthForm()">Back to Login</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="upload-section" class="section">
                    <div id="upload-message" class="message"></div>
                    
                    <div id="upload-form-container">
                        <h2>Upload Data</h2>
                        <p style="color: var(--text-muted); margin-bottom: 30px;">Upload your CSV files to populate the movie database.</p>
                        
                        <div class="upload-bento">
                            <div class="form-group">
                                <div class="file-input-wrapper">
                                    <input type="file" id="csv-file" accept=".csv" onchange="handleFileSelect()" required style="display: none;">
                                    <div class="file-drop-zone" onclick="document.getElementById('csv-file').click()" style="cursor: pointer;">
                                        <span class="upload-icon">üìÅ</span>
                                        <h3 style="margin-bottom: 10px;">Drag & Drop or Click to Upload</h3>
                                        <p style="color: var(--text-muted); font-size: 0.9rem;">Supported formats: .CSV</p>
                                        <div id="file-name" class="file-name" style="margin-top: 15px; color: var(--accent); font-weight: 600;"></div>
                                        <div id="upload-status" style="margin-top: 10px; color: var(--success);"></div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn" id="start-processing-btn" onclick="startProcessing()" style="width: 100%;" disabled>Start Processing</button>
                        </div>
                    </div>

                    <div id="upload-auth-required" class="hidden">
                        <div class="empty-state">üîí Please login to upload files</div>
                    </div>
                </div>

                <div id="tasks-section" class="section">
                    <div id="tasks-message" class="message"></div>
                    
                    <div id="tasks-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>Task History</h2>
                            <button class="btn btn-secondary" onclick="refreshAllTasks()" style="display: flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                Refresh
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <div id="task-list" class="task-list"></div>
                        </div>
                    </div>

                    <div id="tasks-auth-required" class="hidden">
                        <div class="empty-state">üîí Please login to view tasks</div>
                    </div>
                </div>

                <div id="movies-section" class="section">
                    <div id="movies-message" class="message"></div>
                    
                    <div id="movies-container">
                        <h2>Movies Database</h2>
                        
                        <div class="filters-bar">
                            <input type="number" id="filter-year" placeholder="Year" style="width: 100px; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); color: white;">
                            <input type="text" id="filter-language" placeholder="Lang (en)" style="width: 100px; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); color: white;">
                            <select id="sort-field" style="padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); color: white;">
                                <option value="">Sort By...</option>
                                <option value="release_date">Release Date</option>
                                <option value="rating">Rating</option>
                                <option value="title">Title</option>
                            </select>
                            <select id="sort-order" style="padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); color: white;">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                            <button class="btn" onclick="loadMovies()">Search</button>
                            <button class="btn btn-secondary" onclick="resetMovieFilters()">Clear</button>
                        </div>

                        <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-muted); font-size: 0.9rem;">
                            <label>Page: </label>
                            <input type="number" id="movie-page" value="1" min="1" style="width: 60px; padding: 5px; background: transparent; color: white; border: 1px solid var(--glass-border); border-radius: 5px;">
                            <label>Limit: </label>
                            <select id="movie-limit" style="padding: 5px; background: transparent; color: white; border: 1px solid var(--glass-border); border-radius: 5px;">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadMovies()" style="padding: 5px 15px; font-size: 0.8rem;">Go</button>
                        </div>
                        
                        <div class="table-container">
                            <div id="movies-list"></div>
                        </div>
                    </div>

                    <div id="movies-auth-required" class="hidden">
                        <div class="empty-state">üîí Please login to view movies</div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Movie Detail Modal -->
    <div id="movie-modal" class="modal-overlay hidden" onclick="closeMovieModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-movie-title">Movie Title</h2>
                <button class="modal-close" onclick="closeMovieModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-movie-body">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = localStorage.getItem('authToken');
        let currentUser = localStorage.getItem('currentUser');
        let pollingIntervals = {};
        let userTasks = JSON.parse(localStorage.getItem('userTasks') || '[]');

        // Initialize on page load
        window.onload = function() {
            if (authToken) {
                updateAuthState(true);
            }
        };

        function switchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // If called programmatically, find the tab button
                const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                if (tabButton) tabButton.classList.add('active');
            }
            
            document.getElementById(`${tab}-section`).classList.add('active');
            
            // Clear messages
            clearMessages();
            
            // Load tasks if switching to tasks tab
            if (tab === 'tasks' && authToken) {
                loadTasks();
            }
            
            // Load movies if switching to movies tab
            if (tab === 'movies' && authToken) {
                loadMovies();
            }
        }

        function toggleAuthForm() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
            clearMessage('auth-message');
        }

        function updateAuthState(isLoggedIn) {
            if (isLoggedIn) {
                // Show logged-in view
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.add('hidden');
                
                // NEW: Toggle Sidebar Elements
                document.getElementById('logged-in-view').classList.remove('hidden');
                document.getElementById('current-user').textContent = currentUser;
                
                // Hide auth tab and show other tabs
                document.getElementById('auth-tab').classList.add('hidden');
                document.getElementById('upload-tab').classList.remove('hidden');
                document.getElementById('tasks-tab').classList.remove('hidden');
                document.getElementById('movies-tab').classList.remove('hidden');
                
                // Show authenticated sections
                document.getElementById('upload-form-container').classList.remove('hidden');
                document.getElementById('upload-auth-required').classList.add('hidden');
                
                document.getElementById('tasks-container').classList.remove('hidden');
                document.getElementById('tasks-auth-required').classList.add('hidden');

                document.getElementById('movies-container').classList.remove('hidden');
                document.getElementById('movies-auth-required').classList.add('hidden');
                
                // Auto switch to upload if just logged in and on auth page
                if(document.getElementById('auth-section').classList.contains('active')) {
                    switchTab('upload');
                }

            } else {
                // Hide logged-in view
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('logged-in-view').classList.add('hidden');
                
                // Show auth tab and hide other tabs
                document.getElementById('auth-tab').classList.remove('hidden');
                document.getElementById('upload-tab').classList.add('hidden');
                document.getElementById('tasks-tab').classList.add('hidden');
                document.getElementById('movies-tab').classList.add('hidden');
                
                // Hide authenticated sections
                document.getElementById('upload-form-container').classList.add('hidden');
                document.getElementById('upload-auth-required').classList.remove('hidden');
                
                document.getElementById('tasks-container').classList.add('hidden');
                document.getElementById('tasks-auth-required').classList.remove('hidden');

                document.getElementById('movies-container').classList.add('hidden');
                document.getElementById('movies-auth-required').classList.remove('hidden');
                
                // Switch back to auth tab
                switchTab('auth');
            }
        }

        async function register(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('register-name').value,
                email: document.getElementById('register-email').value,
                username: document.getElementById('register-username').value,
                password: document.getElementById('register-password').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.access_token) {
                        authToken = result.access_token;
                        currentUser = data.username;
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', currentUser);
                        
                        showMessage('auth-message', 'Registration successful! You are now logged in.', 'success');
                        updateAuthState(true);
                        event.target.reset();
                    } else {
                        showMessage('auth-message', 'Registration successful! Please login.', 'success');
                        toggleAuthForm();
                        event.target.reset();
                    }
                } else {
                    showMessage('auth-message', result.error || result.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('auth-message', 'Network error: ' + error.message, 'error');
            }
        }

        async function login(event) {
            event.preventDefault();
            
            const data = {
                username: document.getElementById('login-username').value,
                password: document.getElementById('login-password').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.access_token;
                    currentUser = data.username;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', currentUser);
                    
                    showMessage('auth-message', 'Login successful!', 'success');
                    updateAuthState(true);
                    event.target.reset();
                } else {
                    showMessage('auth-message', result.error || result.message || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('auth-message', 'Network error: ' + error.message, 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            userTasks = [];
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userTasks');
            updateAuthState(false);
            showMessage('auth-message', 'Logged out successfully', 'info');
            
            // Stop all polling
            Object.values(pollingIntervals).forEach(interval => clearInterval(interval));
            pollingIntervals = {};
        }

        let uploadedFilePath = null; // Store uploaded file path

        async function handleFileSelect() {
            const fileInput = document.getElementById('csv-file');
            const fileName = document.getElementById('file-name');
            const uploadStatus = document.getElementById('upload-status');
            const startBtn = document.getElementById('start-processing-btn');
            
            if (fileInput.files.length === 0) {
                fileName.textContent = '';
                uploadStatus.textContent = '';
                startBtn.disabled = true;
                uploadedFilePath = null;
                return;
            }

            if (!authToken) {
                showMessage('upload-message', 'Please login first', 'error');
                fileInput.value = '';
                return;
            }
            
            const file = fileInput.files[0];
            fileName.textContent = `Selected: ${file.name}`;
            uploadStatus.textContent = '‚è≥ Uploading...';
            startBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_BASE}/files/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    uploadedFilePath = result.task_id; // Store task ID for processing
                    uploadStatus.textContent = '‚úÖ File uploaded successfully! Click "Start Processing" to begin.';
                    startBtn.disabled = false;
                    showMessage('upload-message', 'File uploaded! Ready to process.', 'success');
                } else {
                    const errorMessage = result.error || result.message || '';
                    if (response.status === 401 || response.status === 422 || 
                        errorMessage.toLowerCase().includes('user not found') || 
                        errorMessage.toLowerCase().includes('unauthorized')) {
                        showMessage('upload-message', 'Session expired or user not found. Please login again.', 'error');
                        setTimeout(() => {
                            logout();
                        }, 2000);
                    } else {
                        showMessage('upload-message', errorMessage || 'Upload failed', 'error');
                    }
                    uploadStatus.textContent = '‚ùå Upload failed';
                    fileInput.value = '';
                    fileName.textContent = '';
                }
            } catch (error) {
                showMessage('upload-message', 'Network error: ' + error.message, 'error');
                uploadStatus.textContent = '‚ùå Upload failed';
                fileInput.value = '';
                fileName.textContent = '';
            }
        }

        async function startProcessing() {
            if (!uploadedFilePath) {
                showMessage('upload-message', 'No file uploaded yet', 'error');
                return;
            }

            const startBtn = document.getElementById('start-processing-btn');
            startBtn.disabled = true;
            startBtn.innerHTML = 'Processing... <span class="spinner"></span>';

            // Add task to list
            const fileInput = document.getElementById('csv-file');
            const fileName = fileInput.files[0]?.name || 'Unknown file';
            
            const newTask = {
                task_id: uploadedFilePath,
                file_path: fileName,
                status: 'pending',
                created_at: new Date().toISOString()
            };
            userTasks.unshift(newTask);
            localStorage.setItem('userTasks', JSON.stringify(userTasks));
            
            // Reset upload form
            fileInput.value = '';
            document.getElementById('file-name').textContent = '';
            document.getElementById('upload-status').textContent = '';
            uploadedFilePath = null;
            
            // Switch to tasks tab and start polling
            setTimeout(() => {
                switchTab('tasks');
                renderTasksTable();
                startPolling(newTask.task_id);
                startBtn.disabled = false;
                startBtn.innerHTML = 'Start Processing';
            }, 500);
        }

        function updateFileName() {
            // This function is no longer needed but kept for compatibility
            handleFileSelect();
        }

        async function uploadFile(event) {
            // This function is no longer used but kept for compatibility
            event.preventDefault();
        }

        async function loadTasks() {
            if (!authToken) {
                showMessage('tasks-message', 'Please login first', 'error');
                return;
            }
            renderTasksTable();
        }

        function renderTasksTable() {
            const taskList = document.getElementById('task-list');
            
            if (userTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <p>No tasks yet. Upload a CSV file to get started!</p>
                    </div>
                `;
                return;
            }
            
            let tableHtml = `
                <table class="task-table">
                    <thead>
                        <tr>
                            <th>Task ID</th>
                            <th>File</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            userTasks.forEach(task => {
                const statusClass = (task.status || 'pending').toLowerCase();
                tableHtml += `
                    <tr id="task-row-${task.task_id}">
                        <td style="font-family: monospace; color: var(--accent);">${task.task_id.substring(0,8)}...</td>
                        <td>${task.file_path || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${task.status || 'pending'}</span></td>
                        <td>${new Date(task.created_at).toLocaleTimeString()}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="refreshTaskStatus('${task.task_id}')" style="padding: 4px 8px; font-size: 11px; display: flex; align-items: center; justify-content: center;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            taskList.innerHTML = tableHtml;
        }

        async function refreshTaskStatus(taskId) {
            if (!authToken) {
                showMessage('tasks-message', 'Please login first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const task = await response.json();
                
                if (!response.ok && (response.status === 401 || response.status === 422)) {
                    showMessage('tasks-message', 'Session expired. Please login again.', 'error');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                    return;
                }
                
                if (response.ok) {
                    const taskIndex = userTasks.findIndex(t => t.task_id === taskId);
                    if (taskIndex !== -1) {
                        userTasks[taskIndex] = {
                            ...userTasks[taskIndex],
                            status: task.status,
                            completed_at: task.completed_at,
                            error_message: task.error_message,
                            records_processed: task.records_processed
                        };
                        localStorage.setItem('userTasks', JSON.stringify(userTasks));
                    }
                    
                    renderTasksTable();
                    
                    if (task.status === 'pending' || task.status === 'processing') {
                        startPolling(taskId);
                    }
                    
                    if (task.status === 'done') {
                        showMessage('tasks-message', `Task completed successfully!`, 'success');
                    } else if (task.status === 'failed') {
                        showMessage('tasks-message', `Task failed: ${task.error_message}`, 'error');
                    }
                } else {
                    showMessage('tasks-message', task.error || task.message || 'Task not found', 'error');
                }
            } catch (error) {
                showMessage('tasks-message', 'Error checking task: ' + error.message, 'error');
            }
        }

        async function refreshAllTasks() {
            if (!authToken) {
                showMessage('tasks-message', 'Please login first', 'error');
                return;
            }
            
            if (userTasks.length === 0) {
                showMessage('tasks-message', 'No tasks to refresh', 'info');
                return;
            }
            
            for (const task of userTasks) {
                await refreshTaskStatus(task.task_id);
            }
        }

        function startPolling(taskId) {
            if (pollingIntervals[taskId]) {
                clearInterval(pollingIntervals[taskId]);
            }
            
            pollingIntervals[taskId] = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const task = await response.json();
                    
                    if (response.ok) {
                        const taskIndex = userTasks.findIndex(t => t.task_id === taskId);
                        if (taskIndex !== -1) {
                            userTasks[taskIndex] = {
                                ...userTasks[taskIndex],
                                status: task.status,
                                completed_at: task.completed_at,
                                error_message: task.error_message,
                                records_processed: task.records_processed
                            };
                            localStorage.setItem('userTasks', JSON.stringify(userTasks));
                        }
                        
                        renderTasksTable();
                        
                        if (task.status === 'done' || task.status === 'failed') {
                            clearInterval(pollingIntervals[taskId]);
                            delete pollingIntervals[taskId];
                            
                            const message = task.status === 'done' 
                                ? `Task completed successfully!` 
                                : `Task failed: ${task.error_message}`;
                            showMessage('tasks-message', message, task.status === 'done' ? 'success' : 'error');
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000);
        }

        async function loadMovies() {
            if (!authToken) {
                showMessage('movies-message', 'Please login first', 'error');
                return;
            }
            
            const moviesList = document.getElementById('movies-list');
            moviesList.innerHTML = '<div class="empty-state"><span class="spinner"></span> Loading...</div>';
            
            try {
                const page = document.getElementById('movie-page').value || 1;
                const limit = document.getElementById('movie-limit').value || 50;
                const year = document.getElementById('filter-year').value;
                const language = document.getElementById('filter-language').value.toLowerCase();
                const sortField = document.getElementById('sort-field').value;
                const sortOrder = document.getElementById('sort-order').value;
                
                let url = `${API_BASE}/movies/?page=${page}&limit=${limit}`;
                if (year) url += `&year=${year}`;
                if (language) url += `&language=${language}`;
                if (sortField) url += `&sort_field=${sortField}&sort_order=${sortOrder}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 422) {
                        showMessage('movies-message', 'Session expired. Please login again.', 'error');
                        setTimeout(() => { logout(); }, 2000);
                        return;
                    }
                    throw new Error('Failed to fetch movies');
                }
                
                const movies = await response.json();
                
                if (movies.length === 0) {
                    let emptyStateHTML = `
                        <div class="empty-state">
                            <p>No movies found.</p>
                        </div>
                    `;
                    if (parseInt(page) > 1) {
                        emptyStateHTML += `<div style="text-align: center; margin-bottom: 40px;"><button class="btn btn-secondary" onclick="previousPage()">‚Üê Previous Page</button></div>`;
                    }
                    moviesList.innerHTML = emptyStateHTML;
                    return;
                }
                
                let tableHtml = `
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Release</th>
                                <th>Lang</th>
                                <th>Rating</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                movies.forEach(movie => {
                    const releaseDate = movie.release_date ? new Date(movie.release_date).toLocaleDateString() : '-';
                    const rating = movie.vote_average ? movie.vote_average.toFixed(1) : '-';
                    
                    tableHtml += `
                        <tr class="movie-row-clickable" onclick="showMovieDetail('${movie._id}')">
                            <td style="font-weight: 600; color: #fff;">${movie.title || 'N/A'}</td>
                            <td>${releaseDate}</td>
                            <td><span style="text-transform: uppercase; font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">${movie.original_language || 'N/A'}</span></td>
                            <td style="color: #fbbf24;">${rating} ‚òÖ</td>
                            <td><span class="status-badge ${movie.status === 'Released' ? 'completed' : 'pending'}">${movie.status || 'N/A'}</span></td>
                        </tr>
                    `;
                });
                
                tableHtml += `</tbody></table>`;
                
                moviesList.innerHTML = tableHtml;
                
                // Pagination Logic (Simplified Visuals)
                const paginationInfo = document.createElement('div');
                paginationInfo.style.marginTop = '20px';
                paginationInfo.style.marginBottom = '40px';
                paginationInfo.style.textAlign = 'center';
                
                let paginationHTML = `<div style="display: flex; justify-content: center; gap: 10px;">`;
                if (parseInt(page) > 1) paginationHTML += `<button class="btn btn-secondary" onclick="previousPage()">‚Üê Prev</button>`;
                if (movies.length >= parseInt(limit)) paginationHTML += `<button class="btn btn-secondary" onclick="nextPage()">Next ‚Üí</button>`;
                paginationHTML += `</div>`;
                paginationInfo.innerHTML = paginationHTML;
                moviesList.appendChild(paginationInfo);
                
            } catch (error) {
                showMessage('movies-message', 'Error loading movies: ' + error.message, 'error');
                moviesList.innerHTML = `<div class="empty-state">Error loading movies.</div>`;
            }
        }

        function resetMovieFilters() {
            document.getElementById('filter-year').value = '';
            document.getElementById('filter-language').value = '';
            document.getElementById('sort-field').value = '';
            document.getElementById('sort-order').value = 'asc';
            document.getElementById('movie-page').value = 1;
            document.getElementById('movie-limit').value = 50;
            loadMovies();
        }

        function nextPage() {
            const pageInput = document.getElementById('movie-page');
            pageInput.value = parseInt(pageInput.value) + 1;
            loadMovies();
        }

        function previousPage() {
            const pageInput = document.getElementById('movie-page');
            const currentPage = parseInt(pageInput.value);
            if (currentPage > 1) {
                pageInput.value = currentPage - 1;
                loadMovies();
            }
        }

        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
        }

        function clearMessage(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function clearMessages() {
            document.querySelectorAll('.message').forEach(msg => msg.style.display = 'none');
        }

        // Movie Detail Modal Functions
        async function showMovieDetail(movieId) {
            try {
                const response = await fetch(`${API_BASE}/movies/${movieId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const movie = await response.json();
                    displayMovieModal(movie);
                } else {
                    showMessage('movies-message', 'Failed to load movie details', 'error');
                }
            } catch (error) {
                console.error('Error fetching movie details:', error);
                showMessage('movies-message', 'Error loading movie details', 'error');
            }
        }

        function displayMovieModal(movie) {
            const modal = document.getElementById('movie-modal');
            const titleEl = document.getElementById('modal-movie-title');
            const bodyEl = document.getElementById('modal-movie-body');

            titleEl.textContent = movie.title || 'N/A';

            const formatCurrency = (amount) => {
                if (!amount || amount === 0) return 'N/A';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(amount);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            };

            const rating = movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A';
            const voteCount = movie.vote_count ? movie.vote_count.toLocaleString() : '0';
            
            bodyEl.innerHTML = `
                ${movie.overview ? `
                    <div class="movie-overview">
                        <div class="detail-label" style="margin-bottom: 10px;">Overview</div>
                        <div style="color: var(--text-main); line-height: 1.6;">${movie.overview}</div>
                    </div>
                ` : ''}

                <div class="movie-stats">
                    <div class="stat-card">
                        <div class="stat-label">Rating</div>
                        <div class="stat-value" style="color: #fbbf24;">${rating} ‚òÖ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Votes</div>
                        <div class="stat-value">${voteCount}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Runtime</div>
                        <div class="stat-value">${movie.runtime ? movie.runtime + ' min' : 'N/A'}</div>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Original Title</div>
                    <div class="detail-value">${movie.original_title || 'N/A'}</div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Release Date</div>
                    <div class="detail-value">${formatDate(movie.release_date)}</div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge ${movie.status === 'Released' ? 'completed' : 'pending'}">${movie.status || 'N/A'}</span>
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Language</div>
                    <div class="detail-value">${movie.languages || 'N/A'} <span style="color: var(--text-muted);">(${movie.original_language ? movie.original_language.toUpperCase() : 'N/A'})</span></div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Budget</div>
                    <div class="detail-value">${formatCurrency(movie.budget)}</div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Revenue</div>
                    <div class="detail-value">${formatCurrency(movie.revenue)}</div>
                </div>

                ${movie.revenue && movie.budget && movie.budget > 0 ? `
                    <div class="detail-row">
                        <div class="detail-label">ROI</div>
                        <div class="detail-value" style="color: ${movie.revenue > movie.budget ? '#10b981' : '#ef4444'};">
                            ${((movie.revenue - movie.budget) / movie.budget * 100).toFixed(1)}%
                        </div>
                    </div>
                ` : ''}

                <div class="detail-row">
                    <div class="detail-label">Genre ID</div>
                    <div class="detail-value">${movie.genre_id || 'N/A'}</div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">Production Co.</div>
                    <div class="detail-value">${movie.production_company_id || 'N/A'}</div>
                </div>

                ${movie.homepage ? `
                    <div class="detail-row">
                        <div class="detail-label">Homepage</div>
                        <div class="detail-value"><a href="${movie.homepage}" target="_blank">${movie.homepage}</a></div>
                    </div>
                ` : ''}

                <div class="detail-row">
                    <div class="detail-label">Database ID</div>
                    <div class="detail-value" style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted);">${movie._id}</div>
                </div>
            `;

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeMovieModal(event) {
            // Close if clicking overlay or close button
            if (!event || event.target === event.currentTarget || event.type === 'click') {
                const modal = document.getElementById('movie-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMovieModal();
            }
        });
    </script>
</body>
</html>